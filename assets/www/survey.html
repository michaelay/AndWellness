<html>
<head>
   <meta name="viewport" content="height=device-height,width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=no;" />
   <link rel="stylesheet" href="http://m.ucla.edu/assets/css.php" type="text/css">
   <link rel="stylesheet" href="css/aws.css" type="text/css">
</head>
<body>

<h1 id="header" class="header center">
   <!--button style="float:left;margin-top:2px;height:30px;">Home</button-->
   AndWellness
</h1>

<h1 class="center" id="desc-title"></h1>
<div id="survey">
</div>
<!--
<div id="survey">
   <div class="content-full content-padded">
      <h1 id="desc-title"></h1>
      <p id="desc-content"></p>
   </div>
   <a id="begin-button" href="#" class="button-full button-light button-padded">Begin</a>
</div>
-->
<a class="button-full button-padded" href="surveylist.html">survey list</a>

<script src="http://m.ucla.edu/assets/js.php"></script>
<script src="js/jquery-1.6.1.min.js"></script>
<script src="js/aws_campaign.js"></script>
<script src="js/aws_utility.js"></script>
<script>
   var enableButton = function(btnObj) { 
      $(btnObj).removeClass("aws-button-disabled");
   }
   var disableButton = function(btnObj) { 
      $(btnObj).addClass("aws-button-disabled");
   } 
   var isButtonDisabled = function(btnObj) { 
      return $(btnObj).hasClass("aws-button-disabled");
   } 
// multiple survey with id like survey1, survey2, survey3, ...
   var onClickNext = function(eventObj) { 
      eventObj.preventDefault();
      if (isButtonDisabled(eventObj.currentTarget)) { 
         alert("Please complete this page before proceeding"); 
         return; 
      } 
      var surveyID = eventObj.data[0];
      var surveyFormID = "survey"+surveyID;
      var surveyButtonSetID = "surveyButtonSet"+surveyID

      var nextID = surveyID + 1; 
      var $nextSurvey = $("#survey > #survey" + nextID);
      if ($nextSurvey) { 
         var $nextButton = $("#survey > #surveyButtonSet" + nextID);
         var $currentSurvey = $("#survey > #survey" + surveyID);
         var $currentButton = $("#survey > #surveyButtonSet" + surveyID);
         $nextSurvey.show();
         $nextButton.show();
         $currentSurvey.hide();  
         $currentButton.hide();  
      } 
   };
   var onClickPrev = function(eventObj) { 
      eventObj.preventDefault();
      if (isButtonDisabled(eventObj.currentTarget)) { 
         return; 
      } 
      var surveyID = eventObj.data[0];
      var surveyFormID = "survey"+surveyID;
      var surveyButtonSetID = "surveyButtonSet"+surveyID

      var prevID = surveyID - 1; 
      if (surveyID > 1) { 
         var $prevSurvey = $("#survey > #survey" + prevID);
         var $prevButton = $("#survey > #surveyButtonSet" + prevID);
         var $currentSurvey = $("#survey > #survey" + surveyID);
         var $currentButton = $("#survey > #surveyButtonSet" + surveyID);
         $prevSurvey.show();
         $prevButton.show();
         $currentSurvey.hide();  
         $currentButton.hide();  
      } 
   };
   var onClickSkip = function(eventObj) { 
      // just move for now... handle data later
      onClickNext(eventObj);
   };
   var onClickTakePhoto = function() { 
      // allow to choose from camera or photo library
      //navigator.camera.getPicture( cameraSuccess, cameraError, [ cameraOptions ] );
      console.log("camera");
   };   
   var onClickChoosePhoto = function() { 
      // allow to choose from camera or photo library
      //navigator.camera.getPicture( cameraSuccess, cameraError, [ cameraOptions ] );
      console.log("choose from library");
   };   
   var onMultiChoiceChange = function(eventObj) { 
      enableButton(eventObj.data[0]); 
   };
   var onSingleChoiceChange = function(eventObj) { 
      enableButton(eventObj.data[0]); 
   };

$(document).ready(function() { 

   // load and parse campaign XML
   var loader = new CampaignXMLLoader(); 
   var xmlString = loader.loadDefaultCampaign(); 

   var id = $.getUrlVars()['id'];
   id = id.replace(/#$/, '');

   var $survey = $(xmlString).find("surveys > survey > id:contains('"+id+"')").parent();
   var $surveyEl = $("#survey");
   $("#desc-title").html($survey.find("title_t").text());
   $("#desc-content").html($survey.find("description").text());

   var currentSurveyID = 1; 
   var $surveyList = $survey.find("contentList").children(); 
   var numSurvey = $surveyList.length;
   console.log(numSurvey);
   //$survey.find("contentList").children().each(function() {
   $surveyList.each(function() {
      var promptText = $(this).find("promptText").text();
      var promptType = $(this).find("promptType").text();
      var survey_displayType = null; 
      var survey_displayLabel = null; 
      var survey_unit = null; 
      var survey_id = null; 
      var survey_promptText = null; 
      var survey_abbreviatedText = null; 
      var survey_explanationTExt = null; 
      var survey_promptType = null; 
      var $survey_properties = null; 
      var survey_default = null; 
      var survey_condition = null; 
      var survey_skippable = null; 
      var survey_skipLabel = null; 
      // parse each children, put them in variables 
      $(this).children().each(function() { 
         switch (this.nodeName.toLowerCase()) { 
         case "displaytype": 
            survey_displayType = $(this).text();
            break; 
         case "displaylabel": 
            survey_displayLabel = $(this).text();
            break; 
         case "unit": 
            survey_unit = $(this).text();
            break; 
         case "id": 
            survey_id = $(this).text(); 
            break; 
         case "prompttext": 
            survey_promptText = $(this).text();
            break; 
         case "abbreviatedtext": 
            survey_abbreviatedText = $(this).text();
            break; 
         case "explanationText": 
            survey_explanationText = $(this).text();
            break; 
         case "prompttype": 
            survey_promptType = $(this).text();
            break; 
         case "properties": 
            $survey_properties = $(this);
            break; 
         case "default": 
            survey_default = $(this).text();
            break; 
         case "condition": 
            survey_condition = $(this).text();
            break; 
         case "skippable": 
            survey_skippable = $(this).text();
            break; 
         case "skiplabel": 
            survey_skipLabel = $(this).text();
            break; 
         // default case is to ignore
         }
      }); 

      // construct HTML based on promptType 
      var surveyID = "survey"+currentSurveyID;
      var surveyButtonSetID = "surveyButtonSet"+currentSurveyID

      // create the buttons
      var $newButtonSet = $('<div class="button-full button-padded"></div>');
      $newButtonSet.attr("id", surveyButtonSetID);

      var firstButtonID = 'prev' + currentSurveyID; 
      var $firstButton; 
      if (currentSurveyID == 1) { // disable prev button
         $firstButton = $('<a class="button-first aws-button-disabled" href="#">Previous</a>');
      } else { 
         $firstButton = $('<a class="button-first" href="#">Previous</a>');
      } 
      $firstButton.attr("id", firstButtonID); 
      $firstButton.click([ currentSurveyID ], onClickPrev);

      var lastButtonID = 'next' + currentSurveyID; 
      var $lastButton = $('<a class="button-last aws-button-disabled" href="#">Next</a>');
      $lastButton.attr("id", lastButtonID); 
      $lastButton.click([ currentSurveyID ], onClickNext);

      $newButtonSet.append($firstButton);
      $newButtonSet.append($lastButton);

      // create the form
      var newFormHTML = '\
      <form class="form-full form-padded">\
         <h1 class="light form-first">'+ survey_promptText +'</h1>\
      </form>';

      var $newForm = $(newFormHTML);
      $newForm.attr("id", surveyID);

      if (survey_skippable == "true") { 
         var $skipButton = $('<a class="button-full button-padded button-light" href=#>'+ survey_skipLabel +'</a>');
         $skipButton.click([ currentSurveyID ], onClickSkip);
         $newForm.append($skipButton);
      } 

      var $formContent = null;
      switch (survey_promptType) { 
      case "timestamp": 
         $formContent = $('<label>timestamp</label>');
         break; 
      case "number": 
         var min;
         var max;
         var contentHTML = '<select>\n';
         $survey_properties.children("property").each(function() { 
            var label = $(this).find("label").text();
            var value = $(this).find("value").text();
            var key = $(this).find("key").text(); 
            if (key == "min") { 
               min = (value?value:label);
            } else if (key == "max") { 
               max = (value?value:label);
            } 
         });
         for (var i=min; i<=max; i++) { 
            if (survey_default != null && survey_default == i) { 
               contentHTML += '<option value="'+i+'" SELECTED>'+i+'</option>\n';
            } else { 
               contentHTML += '<option value="'+i+'">'+i+'</option>\n';
            }  
         } 
         contentHTML += '</select>\n';
         $formContent = $(contentHTML);
         break; 
      case "hours_before_now": 
         $formContent = $('<label>hours_before_now</label>');
         break; 
      case "text": 
         var min; 
         var max; 
         $survey_properties.children("property").each(function() { 
            var label = $(this).find("label").text();
            var value = $(this).find("value").text();
            var key = $(this).find("key").text(); 
            if (key == "min") { 
               min = (value?value:label);
            } else if (key == "max") { 
               max = (value?value:label);
            } 
         });

         var contentHTML = null;
         if (survey_default != null) { 
            contentHTML += '<textarea>'+survey_default+'</textarea>\n';
         } else {  
            contentHTML += '<textarea></textarea>\n';
         } 
         $formContent = $(contentHTML);
         break; 
      case "multi_choice": 
      case "multi_choice_custom": 

         $formContent = $('<ul class=".center" style="list-style:none;">\
                              <li style="clear:both;"></li>\
                           </ul>');
         $survey_properties.children("property").each(function() { 
            var choiceKey = $(this).find("key").text(); 
            var choiceLabel = $(this).find("label").text();
            var choiceValue = $(this).find("value").text();
            choiceValue = choiceValue?choiceValue:choiceKey;
            var $li = $('<li class=".center" style="float:right;width:48%;"></li>');
            var $checkbox = $('<input type="checkbox" name="choice" value="'+choiceValue+'"/>');
            $checkbox.attr('id', 'cb'+surveyID+'_'+choiceValue);
            $checkbox.change([$lastButton], onMultiChoiceChange); // use closure to pass in $lastButton
            $li.append($checkbox); 
            $li.append($('<label for="'+'cb'+surveyID+'_'+choiceValue+'">' + choiceLabel + '</label>'));
            $formContent.append($li);
         });
         $formContent.append($('<li style="clear:both;"></li>'));

         break; 
      case "single_choice": 
      case "single_choice_custom": 

         $formContent = $('<ul class=".center" style="list-style:none;">\
                              <li style="clear:both;"></li>\
                           </ul>');
         $survey_properties.children("property").each(function() { 
            var choiceKey = $(this).find("key").text(); 
            var choiceValue = $(this).find("value").text();
            var choiceLabel = $(this).find("label").text();
            choiceValue = choiceValue?choiceValue:choiceKey;

            var $li = $('<li class=".center" style="float:right;width:48%;"></li>');
            var $radio = $('<input type="radio" name="choice" value="'+choiceValue+'"/>');
            $radio.attr('id', 'rd'+surveyID+'_'+choiceValue);
            $radio.change([$lastButton], onSingleChoiceChange); // use closure to pass in $lastButton
            $li.append($radio); 
            $li.append($('<label for="'+'rd'+surveyID+'_'+choiceValue+'">' + choiceLabel + '</label>'));
            $formContent.append($li);
         });
         $formContent.append($('<li style="clear:both;"></li>'));
         break; 
      case "photo": 
         // if on phone gap, use camera, 
         // otherwise, ask for image upload.
         var contentHTML = null; 
         if ($.hasPhoneGap()) { 
            contentHTML += '\
               <p class="center">\
               <img alt="no image" src="img/no_image.png" />\
               </p>\
               <div class="button-full button-padded button-light">\
                  <a href=# class="button-first" onClick="onClickTakePhoto()">Take photo</a>\
                  <a href=# class="button-last" onClick="onClickChoosePhoto()">Choose from Library</a>\
               </div>\n';
         } else { 
            contentHTML += '<label>photo upload form</label>';
         }
         $formContent = $(contentHTML); 
         break; 
      default: 
         $formContent = $('<label>Unknown prompt type</label>');
         break;
      } 

      $newForm.append($formContent);

      if (currentSurveyID != 1) { 
         $newForm.hide();
         $newButtonSet.hide();
      }

      $surveyEl.append($newForm);
      $surveyEl.append($newButtonSet);

      currentSurveyID++;
   });
});
</script>

</body>
</html>
